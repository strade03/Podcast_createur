name: Build Multi-Platform

on:
  push:
    branches: [ main ]
    # Optimisation : On ne lance pas le build si on modifie juste la doc
    paths-ignore:
      - 'README.md'
      - 'docs/**'
      - '.gitignore'
      - 'LICENSE'
      - 'images/**'
      - '**/*.txt'
  pull_request:
    branches: [ main ]

jobs:
  # =========================================================
  # JOB MACOS
  # =========================================================
  build-macos:
    name: Build macOS
    runs-on: macos-latest
    
    steps:
      - name: Checkout du code
        uses: actions/checkout@v4

      - name: Installation de Qt
        uses: jurplel/install-qt-action@v3
        with:
          version: '6.6.2' # Version stable CI
          host: 'mac'
          target: 'desktop'
          modules: 'qtmultimedia qt5compat'
          
      - name: Téléchargement FFmpeg Statique (macOS)
        run: |
          # On télécharge la version officielle statique pour Mac (evermeet.cx)
          curl -L -o ffmpeg.zip https://evermeet.cx/ffmpeg/ffmpeg-6.1.zip
          unzip ffmpeg.zip
          # On les rend exécutables
          chmod +x ffmpeg

      - name: Compilation
        run: |
          qmake podcast_createur.pro CONFIG+=release
          make -j$(sysctl -n hw.ncpu)

      - name: Création du paquet et Signature
        run: |
          mkdir -p deploy
          cp -r podcast_createur.app deploy/
          mkdir -p deploy/podcast_createur.app/Contents/MacOS
          
          # COPIE DES BINAIRES STATIQUES (ceux qu'on vient de télécharger)
          cp ffmpeg deploy/podcast_createur.app/Contents/MacOS/
          
          # Nettoyage et préparation Qt
          macdeployqt deploy/podcast_createur.app -verbose=2
          
          # Signature (Force + Deep pour signer aussi ffmpeg à l'intérieur)
          codesign --force --deep --sign - deploy/podcast_createur.app
          
          # Création du DMG avec hdiutil
          hdiutil create -volname "PodcastCreateur" -srcfolder deploy/podcast_createur.app -ov -format UDZO deploy/podcast_createur.dmg
          mv deploy/podcast_createur.dmg PodcastCreateur_macOS.dmg

      - name: Upload Artifact macOS
        uses: actions/upload-artifact@v4
        with:
          name: PodcastCreateur-macOS
          path: PodcastCreateur_macOS.dmg

  # =========================================================
  # JOB LINUX (AppImage)
  # =========================================================
  build-linux:
    name: Build Linux (AppImage)
    runs-on: ubuntu-22.04 
    
    steps:
      - name: Checkout du code
        uses: actions/checkout@v4

      - name: Installation de Qt
        uses: jurplel/install-qt-action@v3
        with:
          version: '6.6.2'
          host: 'linux'
          target: 'desktop'
          modules: 'qtmultimedia qt5compat'

      - name: Installation des dépendances Linux
        run: |
          sudo apt-get update
          
          # FIX CRITIQUE : Installer libunwind-dev en premier pour éviter les conflits
          sudo apt-get install -y libunwind-dev

          # Installation des libs graphiques, Gstreamer (audio) et outils
          sudo apt-get install -y build-essential libgl1-mesa-dev libxkbcommon-x11-0 \
            libpulse-dev libasound2-dev \
            libgstreamer1.0-dev libgstreamer-plugins-base1.0-dev \
            libgstreamer-plugins-good1.0-0 libgstreamer-plugins-bad1.0-0 \
            ffmpeg libxcb-cursor0 libxcb-xinerama0

      - name: Compilation
        run: |
          qmake podcast_createur.pro CONFIG+=release
          make -j$(nproc)

      - name: Création de l'AppImage
        run: |
          # 1. Télécharger l'outil de déploiement
          wget -q https://github.com/probonopd/linuxdeployqt/releases/download/continuous/linuxdeployqt-continuous-x86_64.AppImage
          chmod +x linuxdeployqt-continuous-x86_64.AppImage

          # 2. Créer un fichier .desktop minimal pour l'outil
          cat > default.desktop <<EOF
          [Desktop Entry]
          Type=Application
          Name=PodcastCreateur
          Exec=podcast_createur
          Icon=default
          Categories=AudioVideo;Audio;
          EOF
          
          # Icône temporaire si absente
          touch default.png

          # 3. Lancer la création du paquet portable
          unset QT_PLUGIN_PATH
          export LD_LIBRARY_PATH=$LD_LIBRARY_PATH
          
          # -unsupported-allow-new-glibc est nécessaire sur Ubuntu 22.04+
          ./linuxdeployqt-continuous-x86_64.AppImage ./podcast_createur -appimage -unsupported-allow-new-glibc -extra-plugins=iconengines,platformthemes

          # 4. Renommer
          mv PodcastCreateur-*.AppImage PodcastCreateur_Linux.AppImage

      - name: Upload Artifact Linux
        uses: actions/upload-artifact@v4
        with:
          name: PodcastCreateur-Linux
          path: PodcastCreateur_Linux.AppImage

# =========================================================
  # JOB WINDOWS (MSVC) + INSTALLER (Inno Setup)
  # =========================================================
  build-windows:
    name: Build Windows (Installer)
    runs-on: windows-latest
    
    steps:
      - name: Checkout du code
        uses: actions/checkout@v4

      - name: Installation de Qt
        uses: jurplel/install-qt-action@v3
        with:
          version: '6.6.2'
          arch: win64_msvc2019_64
          modules: 'qtmultimedia qt5compat'

      - name: Installation de Inno Setup
        run: choco install innosetup

      - name: Téléchargement de FFmpeg (Windows)
        shell: pwsh
        run: |
          $url = "https://www.gyan.dev/ffmpeg/builds/ffmpeg-release-essentials.zip"
          $output = "ffmpeg.zip"
          Invoke-WebRequest -Uri $url -OutFile $output
          Expand-Archive $output -DestinationPath .
          New-Item -ItemType Directory -Force -Path bin_win
          Move-Item ffmpeg-*-essentials_build/bin/ffmpeg.exe bin_win/

      - name: Configuration de l'environnement MSVC
        uses: ilammy/msvc-dev-cmd@v1

      - name: Compilation
        shell: cmd
        run: |
          qmake podcast_createur.pro CONFIG+=release
          nmake

      - name: Préparation des fichiers (Deploy)
        shell: pwsh
        run: |
          # 1. Créer le dossier qui sera lu par Inno Setup
          New-Item -ItemType Directory -Force -Path deploy
          
          # 2. Copier l'exécutable
          if (Test-Path "release/podcast_createur.exe") {
              Copy-Item "release/podcast_createur.exe" "deploy/"
          } else {
              Copy-Item "podcast_createur.exe" "deploy/"
          }
          
          # 3. Copier FFmpeg
          Copy-Item "bin_win/ffmpeg.exe" "deploy/"
          
          # 4. Copier les ressources (icones) si elles ne sont pas dans le .qrc
          # (Si tu as fait la méthode .qrc, cette étape est optionnelle mais ne fait pas de mal)
          if (Test-Path "icones") {
              Copy-Item -Path "icones" -Destination "deploy/icones" -Recurse
          }

          # 5. Ajouter toutes les DLLs Qt automatiquement
          windeployqt --release --compiler-runtime --no-translations deploy/podcast_createur.exe

      - name: Création de l'installeur (Inno Setup)
        shell: cmd
        run: |
          "C:\Program Files (x86)\Inno Setup 6\ISCC.exe" installer_script_github.iss

      - name: Upload Artifact Windows Installer
        uses: actions/upload-artifact@v4
        with:
          name: PodcastCreateur-Windows-Setup
          path: PodcastCreateur_Setup_Windows.exe   